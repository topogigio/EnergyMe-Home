<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">

    <link rel="stylesheet" type="text/css" href="/css/button.css">
    <link rel="stylesheet" type="text/css" href="/css/main.css">
    <link rel="stylesheet" type="text/css" href="/css/section.css">
    <link rel="stylesheet" type="text/css" href="/css/typography.css">

    <link rel="icon" type="image/png" href="/images/favicon.png">

    <title>Channel</title>
    <style>
        .channel-columns {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
            gap: 10px;
            justify-items: center;
        }

        .channel-columns input[type="text"] {
            width: 90%;
            /* Adjust this value as needed */
            box-sizing: border-box;
        }
    </style>
</head>

<body>
    <div class="buttonNavigation-container">
        <a class="buttonNavigation" type="outer" href="/configuration">Configuration</a>
    </div>

    <div id="channelContainer" class="section-box" style="text-align: center;">
        <h1>Channels</h1>
        <div style="height: 20px;"></div>
        <div class="channel-columns"></div>
    </div>
</body>
<script>
    var meterData;
    var channelData;
    var calibrationData;
    var intervals = []; // Store interval IDs

    function fetchData(endpoint) {
        return new Promise((resolve, reject) => {
            var xhttp = new XMLHttpRequest();
            xhttp.onreadystatechange = function () {
                if (this.readyState == 4) {
                    if (this.status == 200) {
                        resolve(JSON.parse(this.responseText));
                    } else {
                        console.error(`Error fetching data from ${endpoint}. Status: ${this.status}`);
                        reject();
                    }
                }
            };
            xhttp.open("GET", `/rest/${endpoint}`, true);
            xhttp.send();
        });
    }

    Promise.all([fetchData('calibration'), fetchData('get-channel')])
        .then(data => {
            calibrationData = data[0];
            channelData = data[1];
            createChannelBoxes()
        })
        .catch(error => console.error('Error:', error));

    function createChannelBoxes() {
        var container = document.querySelector('.channel-columns');

        channelData.forEach((channel, index) => {
            var box = document.createElement('div');
            box.className = 'section-box';
            box.style.textAlign = 'center';
            var calibrationOptions = calibrationData.map(calibration =>
                `<option value="${calibration.label}" ${calibration.label === channel.calibration.label ? 'selected' : ''}>${calibration.label}</option>`
            ).join('');
            box.innerHTML = `
                    <label>
                        Label:
                        <input type="text" value="${channel.label}" id="label${index}" onchange="updateChannel(${index}, this.value, document.getElementById('calibration${index}').value, document.getElementById('active${index}').checked, document.getElementById('reverse${index}').checked)">
                    </label>
                    <div style="height: 10px;"></div>
                    <label>
                        Calibration:
                        <select id="calibration${index}" onchange="updateChannel(${index}, document.getElementById('label${index}').value, this.value, document.getElementById('active${index}').checked, document.getElementById('reverse${index}').checked)">
                            ${calibrationOptions}
                        </select>
                    </label>

                    <div style="height: 10px;"></div>
                    <label>
                        <input type="checkbox" ${channel.reverse ? 'checked' : ''} id="reverse${index}" onchange="updateChannel(${index}, document.getElementById('label${index}').value, document.getElementById('calibration${index}').value, document.getElementById('active${index}').checked, this.checked)">
                        Reverse
                    </label>
                    <div style="height: 10px;"></div>
                    <label>
                        <input type="checkbox" ${channel.active ? 'checked' : ''} id="active${index}" onchange="updateChannel(${index}, document.getElementById('label${index}').value, document.getElementById('calibration${index}').value, this.checked, document.getElementById('reverse${index}').checked)">
                        Active
                    </label>
                    <div style="height: 10px;"></div>
                    <span id="power${index}"></span>
                `;
            container.appendChild(box);

            if (channel.active) {
                intervals[index] = setInterval(() => {
                    fetchData(`active-power?index=${index}`).then(dataActivePower => {
                        document.getElementById(`power${index}`).innerHTML = `${dataActivePower.toFixed(1)} W`;
                    });
                }, 1000);
            }
        });
    }

    window.updateChannel = function (index, label, calibration, active, reverse) {
        if (!active && intervals[index]) {
            clearInterval(intervals[index]);
            document.getElementById(`power${index}`).innerHTML = '';
            intervals[index] = null; // Set the interval ID to null
        } else if (active && !intervals[index]) {
            intervals[index] = setInterval(() => {
                fetchData(`active-power?index=${index}`).then(dataActivePower => {
                    document.getElementById(`power${index}`).innerHTML = `${dataActivePower.toFixed(1)} W`;
                });
            }, 1000);
        }

        fetchData(`set-channel?index=${index}&label=${encodeURIComponent(label)}&calibration=${encodeURIComponent(calibration)}&active=${active}&reverse=${reverse}`)
            .then(data => {
                console.log(data);
            })
            .catch(error => console.error('Error:', error));
    }
</script>

</html>