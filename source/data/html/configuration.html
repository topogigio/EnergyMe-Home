<!DOCTYPE html>
<html>

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">

    <link rel="stylesheet" type="text/css" href="/css/button.css">
    <link rel="stylesheet" type="text/css" href="/css/main.css">
    <link rel="stylesheet" type="text/css" href="/css/section.css">
    <link rel="stylesheet" type="text/css" href="/css/typography.css">

    <link rel="icon" type="image/png" href="/images/favicon.png">

    <title>Configuration</title>
    <style>
    </style>
</head>

<body>
    <div class="buttonNavigation-container">
        <a class="buttonNavigation" type="home" href="/">Home</a>
        <a class="buttonNavigation" type="inner" href="/calibration">Calibration</a>
        <a class="buttonNavigation" type="inner" href="/channel">Channel</a>
    </div>

    <div class="section-box">
        <h2>General configuration</h2>
        <form id="generalConfigurationForm">
            <div>
                <h3>Cloud services</h3>
                <p><i>Cloud services are used to send data to the cloud. This is useful for monitoring the device remotely.</i></p>
                <input type="checkbox" id="cloudServices" class="config-input">
                <label for="cloudServices">Enable cloud services</label>
            </div>
            <br>
            <button class="buttonForm" onclick="setGeneralConfiguration()" id="setGeneralConfigurationButton">Set configuration</button>
        </form>
    </div>

    <div class="section-box">
        <h2>Logging</h2>
        <p><i>Logging is used to record events and errors. It is useful for debugging and troubleshooting.</i></p>
        <div>
            <h3>Print</h3>
            <p><i>Print logging is used to display events and errors when the serial monitor is available. The serial
                    monitor is available when the device is connected to a computer via USB.</i></p>
            <select id="printLogLevel" class="config-input"></select>
        </div>
        <br>
        <div>
            <h3>Save</h3>
            <p><i>Save logging is used to record events and errors to the internal memory of the device. The internal
                    memory is limited, so it is recommended to only use this for troubleshooting.</i></p>
            <select id="saveLogLevel" class="config-input"></select>
        </div>
        <br>
        <button class="buttonForm" onclick="setLogLevel()" id="setLogLevel">Set logging level</button>
        <a class="buttonForm" href="/log" id="log" target="_blank" style="float: right;">View logs</a>
    </div>

    <div class="section-box">
        <h2>Restart Device</h2>
        <p><i>This will take a few seconds.</i></p>
        <button class="buttonForm" onclick="restart()" id="restart">Restart</button>
    </div>

    <div class="section-box">
        <h2>Disconnect from WiFi</h2>
        <p><i>This will erase the WiFi credentials.</i></p>
        <p><i>The device will create a WiFi network called "EnergyMe".
                Connect to this network and go <a href="http://192.168.4.1" target="_blank">here</a> (192.168.4.1).
                You can then configure the device to connect to your WiFi network.</i></p>
        <button class="buttonForm" onclick="disconnectWifi()" id="disconnect">Disconnect</button>
    </div>

    <script>
        var logLevels = ["Debug", "Info", "Warning", "Error", "Fatal"];

        function populateDropdown() {
            var printLogLevel = document.getElementById("printLogLevel");
            var saveLogLevel = document.getElementById("saveLogLevel");

            for (var i = 0; i < logLevels.length; i++) {
                var opt = document.createElement("option");
                opt.value = logLevels[i];
                opt.innerHTML = logLevels[i];

                printLogLevel.appendChild(opt.cloneNode(true));
                saveLogLevel.appendChild(opt.cloneNode(true));
            }
        }

        function restart() {
            var restartButton = document.getElementById("restart");
            restartButton.innerHTML = "Restarting...";
            restartButton.disabled = true;

            var xhttp = new XMLHttpRequest();
            xhttp.open("POST", "/rest/restart", true);
            xhttp.onreadystatechange = function () {
                if (this.readyState == 4) {
                    if (this.status == 200) {
                        setTimeout(function () {
                            window.location.href = "/";
                        }, 3000);
                    } else {
                        alert("Error restarting device. Response: " + this.responseText);
                        restartButton.innerHTML = "Restart";
                        restartButton.disabled = false;
                    }
                }
            };
            xhttp.send();
        }

        function disconnectWifi() {
            var confirm = window.confirm("Are you sure you want to disconnect from WiFi? You will lose access to the device until you reconnect it to WiFi.");
            if (!confirm) {
                return;
            }
            document.getElementById("disconnect").innerHTML = "Disconnecting...";
            document.getElementById("disconnect").disabled = true;

            var xhttp = new XMLHttpRequest();
            xhttp.open("POST", "/rest/disconnect", true);
            xhttp.onreadystatechange = function () {
                if (this.readyState == 4) {
                    if (this.status == 200) {
                        alert("Successfully disconnected from WiFi. Please connect to the WiFi network called 'EnergyMe' and navigate to 192.168.4.1");
                    } else {
                        alert("Error disconnecting from WiFi. Response: " + this.responseText);
                    }
                }
            };
            xhttp.send();
        }

        function setLogLevel(level) {
            document.getElementById("setLogLevel").innerHTML = "Setting...";
            var logLevels = {
                "Debug": 1,
                "Info": 2,
                "Warning": 3,
                "Error": 4,
                "Fatal": 5
            };

            var printLogLevel = document.getElementById("printLogLevel").value;
            var saveLogLevel = document.getElementById("saveLogLevel").value;

            var printLevelNumber = logLevels[printLogLevel];
            var saveLevelNumber = logLevels[saveLogLevel];

            var xhttp = new XMLHttpRequest();
            xhttp.open("GET", "/rest/set-log?level=" + printLevelNumber + "&type=print", true);
            xhttp.onreadystatechange = function () {
                if (this.readyState == 4) {
                    if (this.status != 200) {
                        alert("Error setting print log level. Response: " + this.responseText);
                    }
                }
            };
            xhttp.send();

            var xhttp2 = new XMLHttpRequest();
            xhttp2.open("GET", "/rest/set-log?level=" + saveLevelNumber + "&type=save", true);
            xhttp2.onreadystatechange = function () {
                if (this.readyState == 4 && this.status != 200) {
                    alert("Error setting save log level. Response: " + this.responseText);
                }
            };
            xhttp2.send();

            document.getElementById("setLogLevel").innerHTML = "Set success";
            document.getElementById("setLogLevel").disabled = true;
            setTimeout(function () {
                document.getElementById("setLogLevel").innerHTML = "Set logging Level";
                document.getElementById("setLogLevel").disabled = false;
            }, 3000);
        }

        function getLogLevel() {
            var xhttp = new XMLHttpRequest();
            xhttp.open("GET", "/rest/get-log", true);
            xhttp.onreadystatechange = function () {
                if (this.readyState == 4) {
                    if (this.status == 200) {
                        var logLevels = JSON.parse(this.responseText);
                        var printLogLevel = logLevels.print.toLowerCase().replace(/\b[a-z]/g, function (letter) {
                            return letter.toUpperCase();
                        });
                        var saveLogLevel = logLevels.save.toLowerCase().replace(/\b[a-z]/g, function (letter) {
                            return letter.toUpperCase();
                        });

                        populateDropdown();
                        document.getElementById("printLogLevel").value = printLogLevel;
                        document.getElementById("saveLogLevel").value = saveLogLevel;
                    } else {
                        alert("Error getting print log level. Response: " + this.responseText);
                    }
                }
            };
            xhttp.send();
        }

        function getGeneralConfiguration() {
            var xhttp = new XMLHttpRequest();
            xhttp.open("GET", "/rest/get-general-configuration", true);
            xhttp.onreadystatechange = function () {
                if (this.readyState == 4) {
                    if (this.status == 200) {
                        var generalConfig = JSON.parse(this.responseText);

                        document.getElementById("cloudServices").checked = generalConfig.isCloudServicesEnabled;
                    } else {
                        alert("Error getting general configuration. Response: " + this.responseText);
                    }
                }
            };
            xhttp.send();
        }

        function setGeneralConfiguration() {
            document.getElementById("setGeneralConfigurationButton").innerHTML = "Setting...";
            document.getElementById("setGeneralConfigurationButton").disabled = true;

            var xhttp = new XMLHttpRequest();
            xhttp.open("POST", "/rest/configuration/general", true);
            xhttp.onreadystatechange = function () {
                if (this.readyState == 4) {
                    if (this.status == 200) {
                        document.getElementById("setGeneralConfigurationButton").innerHTML = "Set success!";
                    } else {
                        alert("Error setting general configuration. Response: " + this.responseText);
                        document.getElementById("setGeneralConfigurationButton").innerHTML = "Set failed!";
                    }
                }
            };
            xhttp.send(JSON.stringify({
                isCloudServicesEnabled: document.getElementById("cloudServices").checked
            }));
            setTimeout(function () {
                document.getElementById("setGeneralConfigurationButton").innerHTML = "Set configuration";
                document.getElementById("setGeneralConfigurationButton").disabled = false;
            }, 3000);
        }

        getGeneralConfiguration();
        getLogLevel();
    </script>

</body>

</html>